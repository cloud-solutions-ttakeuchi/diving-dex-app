# オフライン対応実装計画 (v4.0.0)

## 1. 目的
電波の届かないダイビングスポットや船上においても、ユーザーがログの記録を開始でき、過去のログや図鑑を閲覧できる「オフライン・ファースト」な体験の基礎を構築する。

## 2. 実装フェーズ

### フェーズ 1: Firestore 永続的キャッシュの有効化 [完了]
- **内容**: Firestore の `persistentLocalCache` をネイティブ環境（iOS/Android）でも有効化する。
- **効果**: 一度表示したログ、スポット、生物データが端末に保存され、オフライン時でも高速に表示されるようになる。
- **ファイル**: `wedive-app/src/firebase.ts`

### フェーズ 2: ログ登録・編集のオフライン対応 [完了]
- **内容**: 
  - ネットワーク未接続時に `LogService.addLog` / `updateLog` が呼ばれた場合、Firestore のオフライン書き込みを待ち、ユーザーに「端末保存」として通知する。
  - 保存時のタイムアウト処理をネットワーク状態に応じて切り分ける。
- **制限**: 写真のアップロードは引き続きネットワーク復帰後に自動リトライされる挙動となる。
- **ファイル**: `wedive-app/app/log/add.tsx`, `wedive-app/app/log/edit/[id].tsx`

### フェーズ 3: 接続状態の検知とUIフィードバック [完了]
- **内容**: `@react-native-community/netinfo` を使用して接続状態を検知し、オフライン時には「オフラインモード」バッジを表示する。
- **ファイル**: `wedive-app/src/components/NetworkStatusIndicator.tsx`, `wedive-app/app/_layout.tsx`

### フェーズ 4: 写真のキュー管理とバックグラウンド同期 [未着手]
- **内容**: 写真を含むログ保存時、写真アップロードが成功するまでキューに保持し、完全にオフラインの状態からでも画像を含めた整合性を保つ。

---

## 3. 具体的な工程
1.  **Firestore 設定変更**: `firebase.ts` で `initializeFirestore` に `localCache` 設定を追加。[済]
2.  **SDK のアップデート**: `@react-native-community/netinfo` 等を追加。[済]
3.  **UI/UX 改善**: オフライン通知表示の実装、保存体験の最適化。[済]

## 4. 完了定義 (Definition of Done)
- [x] 端末を機内モードにしても、過去に見たログが表示される。
- [x] オフライン状態でログを保存/編集し、オンライン復帰後に自動的にサーバーへ同期される。
- [x] オフライン中に「保存」をしてもタイムアウトエラーにならず、「端末保存」として完了する。
- [x] `FUNCTIONALITY.md` にオフライン対応状況を追記。
- [x] `CHANGELOG.md` に v4.0.0 を追記。
